name: Auto Rebase PRs

on:
  push:
    branches: [main, master]

jobs:
  auto-rebase:
    name: Rebase Open PRs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Rebase open PRs
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const baseBranch = context.ref.replace('refs/heads/', '');
            
            // Get all open PRs targeting this branch
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              base: baseBranch
            });
            
            core.info(`Found ${prs.length} open PRs targeting ${baseBranch}`);
            
            for (const pr of prs) {
              // Skip draft PRs
              if (pr.draft) {
                core.info(`Skipping draft PR #${pr.number}`);
                continue;
              }
              
              try {
                // Use GitHub's native update branch (rebase-style if enabled)
                await github.rest.pulls.updateBranch({
                  owner,
                  repo,
                  pull_number: pr.number
                });
                core.notice(`Updated PR #${pr.number}: ${pr.title}`);
              } catch (error) {
                if (error.status === 422) {
                  core.info(`PR #${pr.number} is already up-to-date or has conflicts`);
                } else {
                  core.warning(`Failed to update PR #${pr.number}: ${error.message}`);
                }
              }
            }
